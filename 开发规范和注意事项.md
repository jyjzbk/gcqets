# 实验教学管理系统 - 开发规范和注意事项

## 🚨 重要问题记录

### API响应格式不一致问题

**问题描述**：
不同模块使用了不同的API响应处理方式，导致前端代码不一致：

1. **模块1（组织管理等）**：期望 `response.data.data.data` 和 `response.data.data.total`
2. **模块2（设备管理等）**：期望 `response.data.success` 和 `response.data.data.data`

**具体表现**：
```javascript
// 模块1的处理方式（组织管理）
users.value = response.data.data.data
total.value = response.data.data.total

// 模块2的处理方式（设备管理）
if (response.data.success) {
  tableData.value = response.data.data.data
  pagination.total = response.data.data.total
}
```

**标准化解决方案**：
所有新开发的模块必须统一使用以下响应格式：

```javascript
// 后端响应格式（Laravel）
{
  "success": true,
  "message": "操作成功",
  "data": {
    "data": [...],      // 实际数据
    "total": 100,       // 总数
    "current_page": 1,  // 当前页
    "per_page": 20      // 每页数量
  }
}

// 前端处理方式（统一标准）
const loadData = async () => {
  try {
    const response = await api.getList(params)
    if (response.data.success) {
      tableData.value = response.data.data.data
      pagination.total = response.data.data.total
    }
  } catch (error) {
    ElMessage.error('获取数据失败：' + error.message)
  }
}
```

## 📋 开发规范

### 1. 后端开发规范

#### API响应格式
```php
// 成功响应
return response()->json([
    'success' => true,
    'message' => '操作成功',
    'data' => $data
]);

// 错误响应
return response()->json([
    'success' => false,
    'message' => '错误信息',
    'errors' => $errors
], 400);
```

#### 控制器规范
```php
class ExampleController extends Controller
{
    public function index(Request $request)
    {
        // 权限检查
        $user = $request->user();
        
        // 数据查询（考虑权限过滤）
        $query = Model::query();
        if ($user->user_type !== 'sysadmin') {
            $query->where('organization_id', $user->organization_id);
        }
        
        // 分页
        $data = $query->paginate($request->get('per_page', 20));
        
        return response()->json([
            'success' => true,
            'data' => $data
        ]);
    }
}
```

### 2. 前端开发规范

#### API调用标准
```javascript
// API文件结构
export const exampleApi = {
  getList(params) {
    return request.get('/examples', { params })
  },
  
  getDetail(id) {
    return request.get(`/examples/${id}`)
  },
  
  create(data) {
    return request.post('/examples', data)
  },
  
  update(id, data) {
    return request.put(`/examples/${id}`, data)
  },
  
  delete(id) {
    return request.delete(`/examples/${id}`)
  }
}
```

#### 组件数据处理标准
```javascript
// 列表页面标准结构
const tableData = ref([])
const loading = ref(false)
const pagination = reactive({
  current: 1,
  size: 20,
  total: 0
})

const loadData = async () => {
  loading.value = true
  try {
    const params = {
      page: pagination.current,
      per_page: pagination.size,
      ...searchForm
    }
    
    const response = await exampleApi.getList(params)
    if (response.data.success) {
      tableData.value = response.data.data.data
      pagination.total = response.data.data.total
    }
  } catch (error) {
    ElMessage.error('获取数据失败：' + error.message)
  } finally {
    loading.value = false
  }
}
```

### 3. 数据库设计规范

#### 表命名规范
- 使用复数形式：`users`, `organizations`, `experiment_catalogs`
- 关联表使用单数：`user_role`, `organization_user`
- 使用下划线分隔：`experiment_catalogs`, `curriculum_standards`

#### 字段规范
```sql
-- 必需字段
id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT
created_at timestamp NULL DEFAULT NULL
updated_at timestamp NULL DEFAULT NULL

-- 软删除
deleted_at timestamp NULL DEFAULT NULL

-- 组织关联
organization_id bigint(20) UNSIGNED COMMENT '组织机构ID'

-- 创建者
creator_id bigint(20) UNSIGNED COMMENT '创建者ID'

-- 状态字段
status enum('active','inactive') NOT NULL DEFAULT 'active'
```

## 🔧 技术栈规范

### 后端技术栈
- **框架**：Laravel 11
- **数据库**：MySQL 8.0+
- **认证**：Laravel Sanctum
- **API设计**：RESTful
- **代码规范**：PSR-12

### 前端技术栈
- **框架**：Vue 3 + Composition API
- **UI组件**：Element Plus
- **构建工具**：Vite
- **状态管理**：Pinia
- **HTTP客户端**：Axios
- **代码规范**：ESLint + Prettier

## 🛡️ 安全规范

### 权限控制
```php
// 控制器中的权限检查
public function index(Request $request)
{
    $user = $request->user();
    
    // 系统管理员可以查看所有数据
    if ($user->user_type === 'sysadmin') {
        $query = Model::query();
    } else {
        // 普通用户只能查看本组织数据
        $query = Model::where('organization_id', $user->organization_id);
    }
    
    // 继续处理...
}
```

### 数据验证
```php
// 使用FormRequest进行数据验证
class StoreExampleRequest extends FormRequest
{
    public function rules()
    {
        return [
            'name' => 'required|string|max:255',
            'email' => 'required|email|unique:examples',
            'organization_id' => 'required|exists:organizations,id'
        ];
    }
}
```

## 📁 文件组织规范

### 后端文件结构
```
backend/
├── app/Http/Controllers/Api/
│   ├── ExperimentCatalogController.php
│   ├── CurriculumStandardController.php
│   └── ...
├── app/Models/
│   ├── ExperimentCatalog.php
│   ├── CurriculumStandard.php
│   └── ...
├── app/Http/Requests/
│   ├── StoreExperimentCatalogRequest.php
│   └── ...
└── database/migrations/
```

### 前端文件结构
```
frontend/src/
├── views/
│   ├── experiment/
│   ├── equipment/
│   └── ...
├── components/
│   ├── common/
│   └── ...
├── api/
│   ├── experiment.js
│   ├── equipment.js
│   └── ...
├── stores/
│   ├── auth.js
│   └── ...
└── utils/
```

## 🧪 测试规范

### 测试账户
```
系统管理员: sysadmin / 123456
学区管理员: lianzhou_admin / 123456  
校长用户: dongcheng_principal / 123456
```

### API测试
每个新功能都必须包含：
1. 单元测试
2. 功能测试
3. 权限测试
4. 边界条件测试

## 📝 代码提交规范

### Git提交信息格式
```
type(scope): description

feat(experiment): 添加实验目录管理功能
fix(auth): 修复登录token过期问题
docs(readme): 更新项目文档
style(ui): 调整表格样式
refactor(api): 重构API响应格式
test(unit): 添加用户管理单元测试
```

### 分支管理
- `main`: 主分支，稳定版本
- `develop`: 开发分支
- `feature/xxx`: 功能分支
- `hotfix/xxx`: 紧急修复分支

## 🔄 持续集成

### 部署检查清单
- [ ] 数据库迁移已执行
- [ ] 环境变量已配置
- [ ] 依赖包已安装
- [ ] 权限配置正确
- [ ] API测试通过
- [ ] 前端构建成功

---

**重要提醒**：在开发新模块时，请严格遵循本文档的规范，特别是API响应格式的统一性。如有疑问，请参考已完成的模块2（设备管理）的实现方式。
